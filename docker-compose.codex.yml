version: '3.8'

services:
  codex-mirror:
    image: ghcr.io/openai/codex-universal:latest
    container_name: ice-webapp-codex-test
    environment:
      # Configure runtime versions to match Codex environment
      - CODEX_ENV_PYTHON_VERSION=3.12
      - CODEX_ENV_NODE_VERSION=22
      - CODEX_ENV_RUST_VERSION=1.87.0
      - CODEX_ENV_GO_VERSION=1.23.8
      - CODEX_ENV_SWIFT_VERSION=6.1
      
      # Codex-specific environment variables
      - CONTAINER=docker
      - CODESPACE_NAME=codex
      - OPENAI_CODEX=true
      - SHELL=/bin/bash
      - DEBIAN_FRONTEND=noninteractive
      
    volumes:
      # Mount current directory as workspace (mirrors Codex behavior)
      - .:/workspace/ice-webapp
      # Mount test scripts
      - ./tests:/workspace/tests
      # Mount tools directory
      - ./tools:/workspace/tools
      
    working_dir: /workspace/ice-webapp
    
    # Setup nvm environment and keep container running
    command: >
      bash -c "
      echo 'ğŸ”§ Setting up Codex Universal environment...' &&
      source ~/.nvm/nvm.sh &&
      nvm use 22 &&
      echo 'Node.js:' && node --version &&
      echo 'npm:' && npm --version &&
      echo 'pnpm:' && pnpm --version &&
      echo 'ğŸš€ ICE-WEBAPP Codex Universal container ready' &&
      tail -f /dev/null
      "
    
    # Enable networking for package installation during setup
    network_mode: bridge
    
    # Set resource limits similar to Codex
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'

  # Test runner service - tests both mounted and cloned repo
  codex-test-runner:
    image: ghcr.io/openai/codex-universal:latest
    container_name: ice-webapp-test-runner
    environment:
      - CODEX_ENV_NODE_VERSION=22
      - CODEX_ENV_PYTHON_VERSION=3.12
      - CONTAINER=docker
      - SHELL=/bin/bash
      - DEBIAN_FRONTEND=noninteractive
    volumes:
      - .:/workspace/ice-webapp
      - ./tests:/workspace/tests
    working_dir: /workspace
    command: >
      bash -c "
      echo 'ğŸ§ª Starting ICE-WEBAPP Codex Test Suite' &&
      echo '=======================================' &&
      
      # Test 1: Clone fresh repository (mirrors Codex behavior)
      echo 'ğŸ“¥ Test 1: Testing with fresh repository clone...' &&
      git clone https://github.com/DrJLabs/ice-webapp.git /workspace/test-repo &&
      cd /workspace/test-repo &&
      echo 'ğŸš€ Running setup-codex.sh on cloned repository...' &&
      bash setup-codex.sh &&
      echo 'âœ… Test 1 completed' &&
      
      # Test 2: Test mounted repository (development workflow)
      echo 'ğŸ“ Test 2: Testing with mounted repository...' &&
      cd /workspace/ice-webapp &&
      echo 'ğŸš€ Running setup-codex.sh on mounted repository...' &&
      bash setup-codex.sh &&
      echo 'âœ… Test 2 completed' &&
      
      echo 'ğŸ‰ All tests completed'
      "
    depends_on:
      - codex-mirror
    profiles:
      - test 