services:
  codex-environment:
    build:
      context: .
      dockerfile: Dockerfile.codex
    volumes:
      - .:/workspace/ice-webapp:cached
    environment:
      - CODACY_ACCOUNT_TOKEN=${CODACY_ACCOUNT_TOKEN}
      - CODACY_PROJECT_TOKEN=${CODACY_PROJECT_TOKEN}
    tty: true
    stdin_open: true

  codex-mirror:
    image: ubuntu:24.04
    container_name: ice-webapp-codex-test
    environment:
      # Configure runtime versions to match Codex environment
      - CODEX_ENV_PYTHON_VERSION=3.12
      - CODEX_ENV_NODE_VERSION=22
      - CODEX_ENV_RUST_VERSION=1.87.0
      - CODEX_ENV_GO_VERSION=1.23.8
      - CODEX_ENV_SWIFT_VERSION=6.1
      
      # Codex-specific environment variables  
      - CONTAINER=docker
      - CODESPACE_NAME=codex
      - OPENAI_CODEX=true
      - SHELL=/bin/bash
      - DEBIAN_FRONTEND=noninteractive
      
      # Simulate Codex network restrictions
      - COREPACK_ENABLE_STRICT=0
      - COREPACK_ENABLE_NETWORK=0
      - NODE_OPTIONS="--no-warnings"
      
    volumes:
      # Mount current directory as workspace (mirrors Codex behavior)
      - .:/workspace/ice-webapp
      # Mount test scripts
      - ./tests:/workspace/tests
      # Mount tools directory
      - ./tools:/workspace/tools
      
    working_dir: /workspace/ice-webapp
    
    # Setup accurate Codex environment avoiding npm 11.x corepack bug
    command: >
      bash -c "
      echo 'ğŸ”§ Setting up ICE-WEBAPP Codex Universal environment (fixing npm/cli#8075)...' &&
      apt-get update -qq &&
      apt-get install -y -qq curl wget git build-essential python3 python3-pip iptables dnsutils &&
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash - &&
      apt-get install -y -qq nodejs &&
      echo 'Initial versions:' &&
      echo '  Node.js:' && node --version &&
      echo '  npm:' && npm --version &&
      echo 'ğŸ”§ Applying fix for npm 11.x corepack bug (npm/cli#8075)...' &&
      npm install -g npm@10.9.0 &&
      npm cache clean --force &&
      echo 'âš ï¸  Simulating Codex network restrictions...' &&
      echo '127.0.0.1 repo.yarnpkg.com' >> /etc/hosts &&
      echo '127.0.0.1 registry.yarnpkg.com' >> /etc/hosts &&
      echo '127.0.0.1 yarnpkg.com' >> /etc/hosts &&
      npm config set registry https://registry.npmjs.org/ &&
      npm install -g corepack@latest &&
      npm install -g pnpm@latest 2>/dev/null || echo 'pnpm install failed (simulating network restrictions)' &&
      echo 'âœ… Environment setup completed with npm/cli#8075 fix applied' &&
      echo 'Final versions:' &&
      echo '  Node.js:' && node --version &&
      echo '  npm:' && npm --version &&
      echo '  pnpm:' && (pnpm --version 2>/dev/null || echo 'restricted by network policy') &&
      echo '  Python:' && python3 --version &&
      echo 'ğŸš€ ICE-WEBAPP Codex Universal container ready (npm 11.x bug fixed)' &&
      sleep infinity
      "
    
    # Enable networking for package installation during setup
    network_mode: bridge
    
    # Set resource limits similar to Codex
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'

  # Test runner service - tests both mounted and cloned repo
  codex-test-runner:
    image: ghcr.io/openai/codex-universal:latest
    container_name: ice-webapp-test-runner
    environment:
      - CODEX_ENV_NODE_VERSION=22
      - CODEX_ENV_PYTHON_VERSION=3.12
      - CONTAINER=docker
      - SHELL=/bin/bash
      - DEBIAN_FRONTEND=noninteractive
    volumes:
      - .:/workspace/ice-webapp
      - ./tests:/workspace/tests
    working_dir: /workspace
    command: >
      bash -c "
      echo 'ğŸ§ª Starting ICE-WEBAPP Codex Test Suite' &&
      echo '=======================================' &&
      
      # Test 1: Clone fresh repository (mirrors Codex behavior)
      echo 'ğŸ“¥ Test 1: Testing with fresh repository clone...' &&
      git clone https://github.com/DrJLabs/ice-webapp.git /workspace/test-repo &&
      cd /workspace/test-repo &&
      echo 'ğŸš€ Running setup-codex.sh on cloned repository...' &&
      bash setup-codex.sh &&
      echo 'âœ… Test 1 completed' &&
      
      # Test 2: Test mounted repository (development workflow)
      echo 'ğŸ“ Test 2: Testing with mounted repository...' &&
      cd /workspace/ice-webapp &&
      echo 'ğŸš€ Running setup-codex.sh on mounted repository...' &&
      bash setup-codex.sh &&
      echo 'âœ… Test 2 completed' &&
      
      echo 'ğŸ‰ All tests completed'
      "
    depends_on:
      - codex-mirror
    profiles:
      - test 