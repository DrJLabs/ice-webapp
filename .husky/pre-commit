#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üßä Running ICE-WEBAPP quality gates..."

# 1. TypeScript validation
echo "Checking TypeScript..."
pnpm run type-check || { echo "‚ùå TypeScript check failed!"; exit 1; }

# 2. Linting
echo "Running linter..."
pnpm run lint || { echo "‚ùå Linting failed!"; exit 1; }

# 3. Tests with coverage
echo "Running tests with coverage..."
pnpm run test:coverage || { echo "‚ùå Tests failed!"; exit 1; }

# 4. Security scan with Codacy
if [ -f "./tools/codacy-runtime.sh" ]; then
  echo "Running security scan..."
  CODACY_PROJECT_TOKEN=$(grep CODACY_PROJECT_TOKEN tools/.codacy-tokens | cut -d'"' -f2)
  export CODACY_PROJECT_TOKEN
  ./tools/codacy-runtime.sh || { echo "‚ùå Security scan failed!"; exit 1; }
fi

# 5. Upload coverage to Codacy
echo "Uploading coverage to Codacy..."
pnpm run coverage:upload || { echo "‚ö†Ô∏è Coverage upload failed, but continuing..."; }

echo "‚úÖ All quality gates passed!"
