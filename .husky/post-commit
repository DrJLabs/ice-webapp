#!/bin/sh
# husky v10 format - no longer using the husky.sh approach

# Skip post-commit hook if SKIP_POST_COMMIT or SKIP_HOOKS is set
if [ -n "$SKIP_POST_COMMIT" ] || [ -n "$SKIP_HOOKS" ]; then
  echo "‚ö†Ô∏è Skipping post-commit hook (SKIP_POST_COMMIT or SKIP_HOOKS is set)"
  exit 0
fi

echo "üßä Running post-commit quality gates..."

# Generate coverage report
echo "üìä Generating test coverage report..."
pnpm run test:coverage || { echo "‚ùå Test coverage generation failed"; exit 1; }

# Source Codacy tokens
if [ -f "./tools/.codacy-tokens" ]; then
  echo "üîë Loading Codacy tokens..."
  . ./tools/.codacy-tokens
else
  echo "‚ùå Codacy tokens not found. Skipping Codacy operations."
  exit 0
fi

# Upload coverage to Codacy if tokens exist
if [ -n "$CODACY_PROJECT_TOKEN" ]; then
  echo "üì§ Uploading coverage to Codacy..."
  curl -Ls https://coverage.codacy.com/get.sh > codacy-coverage.sh && bash codacy-coverage.sh report -r coverage/lcov.info || { echo "‚ùå Coverage upload failed"; }
  
  # Configure quality gates
  echo "‚öôÔ∏è Configuring Codacy quality gates..."
  pnpm run codacy:setup-all || { echo "‚ö†Ô∏è Quality gate configuration failed"; }
else
  echo "‚ùå Codacy project token not found. Skipping Codacy operations."
fi

echo "‚úÖ Post-commit tasks completed" 