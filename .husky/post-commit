#!/bin/sh

echo "üßä Running post-commit quality gates..."

# Generate test coverage report
echo "üìä Generating test coverage report..."
pnpm run test:coverage

# Load Codacy tokens if they exist
if [ -f "./tools/.codacy-tokens" ]; then
  echo "üîë Loading Codacy tokens..."
  . ./tools/.codacy-tokens
else
  echo "‚ùå Codacy tokens not found. Skipping Codacy operations."
  exit 0
fi

# Upload coverage to Codacy if tokens exist
if [ -n "$CODACY_PROJECT_TOKEN" ]; then
  echo "üì§ Uploading coverage to Codacy..."
  curl -Ls https://coverage.codacy.com/get.sh > codacy-coverage.sh && bash codacy-coverage.sh report -r coverage/lcov.info || { echo "‚ùå Coverage upload failed"; }
  
  # Configure quality gates
  echo "‚öôÔ∏è Configuring Codacy quality gates..."
  pnpm run codacy:setup-all || { echo "‚ö†Ô∏è Quality gate configuration failed"; }
else
  echo "‚ùå Codacy project token not found. Skipping Codacy operations."
fi

echo "‚úÖ Post-commit tasks completed"
