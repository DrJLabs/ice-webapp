#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Skip post-commit hook if SKIP_POST_COMMIT or SKIP_HOOKS is set
if [ -n "$SKIP_POST_COMMIT" ] || [ -n "$SKIP_HOOKS" ]; then
  echo "âš ï¸ Skipping post-commit hook (SKIP_POST_COMMIT or SKIP_HOOKS is set)"
  exit 0
fi

echo "ğŸ§Š Running post-commit quality gates..."

# Generate coverage report
echo "ğŸ“Š Generating test coverage report..."
pnpm run test:coverage || { echo "âŒ Test coverage generation failed"; exit 1; }

# Source Codacy tokens
if [ -f "./tools/.codacy-tokens" ]; then
  echo "ğŸ”‘ Loading Codacy tokens..."
  . ./tools/.codacy-tokens
else
  echo "âŒ Codacy tokens not found. Skipping Codacy operations."
  exit 0
fi

# Upload coverage to Codacy if tokens exist
if [ -n "$CODACY_PROJECT_TOKEN" ]; then
  echo "ğŸ“¤ Uploading coverage to Codacy..."
  bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r coverage/lcov.info || { echo "âŒ Coverage upload failed"; }
  
  # Configure quality gates
  echo "âš™ï¸ Configuring Codacy quality gates..."
  pnpm run codacy:setup-all || { echo "âš ï¸ Quality gate configuration failed"; }
else
  echo "âŒ Codacy project token not found. Skipping Codacy operations."
fi

echo "âœ… Post-commit tasks completed" 