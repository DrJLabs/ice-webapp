#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Skip post-commit hook if SKIP_POST_COMMIT or SKIP_HOOKS is set
if [ -n "$SKIP_POST_COMMIT" ] || [ -n "$SKIP_HOOKS" ]; then
  echo "⚠️ Skipping post-commit hook (SKIP_POST_COMMIT or SKIP_HOOKS is set)"
  exit 0
fi

echo "🧊 Running post-commit quality gates..."

# Generate coverage report
echo "📊 Generating test coverage report..."
pnpm run test:coverage || { echo "❌ Test coverage generation failed"; exit 1; }

# Source Codacy tokens
if [ -f "./tools/.codacy-tokens" ]; then
  echo "🔑 Loading Codacy tokens..."
  . ./tools/.codacy-tokens
else
  echo "❌ Codacy tokens not found. Skipping Codacy operations."
  exit 0
fi

# Upload coverage to Codacy if tokens exist
if [ -n "$CODACY_PROJECT_TOKEN" ]; then
  echo "📤 Uploading coverage to Codacy..."
  bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r coverage/lcov.info || { echo "❌ Coverage upload failed"; }
  
  # Configure quality gates
  echo "⚙️ Configuring Codacy quality gates..."
  pnpm run codacy:setup-all || { echo "⚠️ Quality gate configuration failed"; }
else
  echo "❌ Codacy project token not found. Skipping Codacy operations."
fi

echo "✅ Post-commit tasks completed" 